<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="me.realimpact.telecom.calculation.infrastructure.adapter.mybatis.ContractQueryMapper">

    <!-- 계약 ID 목록 조회 (Spring Batch용) -->
    <select id="findContractIds" resultType="Long">
        SELECT DISTINCT c.contract_id
        FROM contract c
        WHERE 1=1
        <!-- 계약 ID 조건 (조건부) -->
        <if test="contractIds != null and contractIds.size() > 0">
            AND c.contract_id IN
            <foreach item="contractId" collection="contractIds" open="(" separator="," close=")">
                #{contractId}
            </foreach>
        </if>

        <!-- 계약 유효 기간 필터링 -->
        AND COALESCE(c.subscribed_at, '1900-01-01') &lt;= #{billingEndDate}
        AND COALESCE(c.terminated_at, '9999-12-31') &gt; #{billingStartDate}
        AND COALESCE(c.initially_subscribed_at, '1900-01-01') &lt;= #{billingEndDate}
        AND COALESCE(c.preffered_termination_date, '9999-12-31') &gt; #{billingStartDate}
        ORDER BY c.contract_id
    </select>


</mapper>