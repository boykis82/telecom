<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="me.realimpact.telecom.testgen.mapper.TestDataMapper">

    <!-- Contract Batch Insert -->
    <insert id="insertContracts" parameterType="java.util.List">
        INSERT INTO contract (
            contract_id, 
            subscribed_at, 
            initially_subscribed_at, 
            terminated_at, 
            preffered_termination_date
        ) VALUES
        <foreach collection="list" item="contract" separator=",">
            (
                #{contract.contractId},
                #{contract.subscribedAt},
                #{contract.initiallySubscribedAt},
                #{contract.terminatedAt},
                #{contract.prefferedTerminationDate}
            )
        </foreach>
    </insert>

    <!-- Product Batch Insert -->
    <insert id="insertProducts" parameterType="java.util.List">
        INSERT INTO product (
            contract_id,
            product_offering_id,
            effective_start_date_time,
            effective_end_date_time,
            subscribed_at,
            activated_at,
            terminated_at
        ) VALUES
        <foreach collection="list" item="product" separator=",">
            (
                #{product.contractId},
                #{product.productOfferingId},
                #{product.effectiveStartDateTime},
                #{product.effectiveEndDateTime},
                #{product.subscribedAt},
                #{product.activatedAt},
                #{product.terminatedAt}
            )
        </foreach>
    </insert>

    <!-- Suspension Batch Insert -->
    <insert id="insertSuspensions" parameterType="java.util.List">
        <if test="list != null and list.size() > 0">
            INSERT INTO suspension (
                contract_id,
                suspension_type_code,
                effective_start_date_time,
                effective_end_date_time,
                suspension_type_description
            ) VALUES
            <foreach collection="list" item="suspension" separator=",">
                (
                    #{suspension.contractId},
                    #{suspension.suspensionTypeCode},
                    #{suspension.effectiveStartDateTime},
                    #{suspension.effectiveEndDateTime},
                    #{suspension.suspensionTypeDescription}
                )
            </foreach>
        </if>
    </insert>

    <!-- Product Offering IDs 조회 -->
    <select id="selectProductOfferingIds" resultType="String">
        SELECT product_offering_id 
        FROM product_offering 
        ORDER BY product_offering_id
    </select>
    
    <!-- Contract IDs 조회 -->
    <select id="selectContractIds" resultType="Long">
        SELECT contract_id 
        FROM contract
        ORDER BY contract_id
    </select>

    <!-- 테이블 초기화 (외래키 제약 조건 해결) -->
    
    <!-- 외래키 체크 비활성화 -->
    <update id="disableForeignKeyChecks">
        SET FOREIGN_KEY_CHECKS = 0
    </update>
    
    <!-- 외래키 체크 활성화 -->  
    <update id="enableForeignKeyChecks">
        SET FOREIGN_KEY_CHECKS = 1
    </update>
    
    <!-- 테이블별 DELETE -->
    <delete id="truncateSuspensions">
        DELETE FROM suspension
    </delete>
    
    <delete id="truncateProducts">  
        DELETE FROM product
    </delete>
    
    <delete id="truncateContracts">
        DELETE FROM contract
    </delete>
    
    <delete id="truncateDeviceInstallmentDetails">
        DELETE FROM device_installment_detail
    </delete>
    
    <delete id="truncateDeviceInstallmentMasters">
        DELETE FROM device_installment_master
    </delete>
    
    <delete id="truncateInstallationHistories">
        DELETE FROM installation_history
    </delete>

    <!-- DeviceInstallmentMaster Batch Insert -->
    <insert id="insertDeviceInstallmentMasters" parameterType="java.util.List">
        <if test="list != null and list.size() > 0">
            INSERT INTO device_installment_master (
                contract_id,
                installment_sequence,
                installment_start_date,
                total_installment_amount,
                installment_months,
                billed_count
            ) VALUES
            <foreach collection="list" item="master" separator=",">
                (
                    #{master.contractId},
                    #{master.installmentSequence},
                    #{master.installmentStartDate},
                    #{master.totalInstallmentAmount},
                    #{master.installmentMonths},
                    #{master.billedCount}
                )
            </foreach>
        </if>
    </insert>

    <!-- DeviceInstallmentDetail Batch Insert -->
    <insert id="insertDeviceInstallmentDetails" parameterType="java.util.List">
        <if test="list != null and list.size() > 0">
            INSERT INTO device_installment_detail (
                contract_id,
                installment_sequence,
                installment_round,
                installment_amount,
                billing_completed_date
            ) VALUES
            <foreach collection="list" item="detail" separator=",">
                (
                    #{detail.contractId},
                    #{detail.installmentSequence},
                    #{detail.installmentRound},
                    #{detail.installmentAmount},
                    #{detail.billingCompletedDate}
                )
            </foreach>
        </if>
    </insert>

    <!-- InstallationHistory Batch Insert -->
    <insert id="insertInstallationHistories" parameterType="java.util.List">
        <if test="list != null and list.size() > 0">
            INSERT INTO installation_history (
                contract_id,
                sequence_number,
                installation_date,
                installation_fee,
                billed_flag
            ) VALUES
            <foreach collection="list" item="history" separator=",">
                (
                    #{history.contractId},
                    #{history.sequenceNumber},
                    #{history.installationDate},
                    #{history.installationFee},
                    #{history.billedFlag}
                )
            </foreach>
        </if>
    </insert>

    <!-- Contract Discount 관련 쿼리 -->
    
    <!-- 기존 Contract Discount 데이터 삭제 -->
    <delete id="deleteAllContractDiscounts">
        DELETE FROM contract_discount
    </delete>
    
    <!-- Contract-Product 조합 조회 -->
    <select id="selectContractProducts" 
            resultType="me.realimpact.telecom.testgen.ContractDiscountDataGenerator$ContractProduct">
        SELECT DISTINCT 
            p.contract_id as contractId,
            p.product_offering_id as productOfferingId
        FROM product p
        ORDER BY p.contract_id, p.product_offering_id
    </select>
    
    <!-- Contract Discount 개별 삽입 (호환성) -->
    <insert id="insertContractDiscount" 
            parameterType="me.realimpact.telecom.testgen.ContractDiscountDataGenerator$ContractDiscountData">
        INSERT INTO contract_discount (
            contract_id,
            discount_id,
            discount_start_date,
            discount_end_date,
            product_offering_id,
            discount_aply_unit,
            discount_amt,
            discount_rate,
            discount_applied_amount
        ) VALUES (
            #{contractId},
            #{discountId},
            #{discountStartDate},
            #{discountEndDate},
            #{productOfferingId},
            #{discountAplyUnit},
            #{discountAmt},
            #{discountRate},
            #{discountAppliedAmount}
        )
    </insert>
    
    <!-- Contract Discount Bulk 삽입 -->
    <insert id="insertContractDiscounts" parameterType="java.util.List">
        <if test="list != null and list.size() > 0">
            INSERT INTO contract_discount (
                contract_id,
                discount_id,
                discount_start_date,
                discount_end_date,
                product_offering_id,
                discount_aply_unit,
                discount_amt,
                discount_rate,
                discount_applied_amount
            ) VALUES
            <foreach collection="list" item="discount" separator=",">
                (
                    #{discount.contractId},
                    #{discount.discountId},
                    #{discount.discountStartDate},
                    #{discount.discountEndDate},
                    #{discount.productOfferingId},
                    #{discount.discountAplyUnit},
                    #{discount.discountAmt},
                    #{discount.discountRate},
                    #{discount.discountAppliedAmount}
                )
            </foreach>
        </if>
    </insert>

</mapper>